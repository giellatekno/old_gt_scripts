#!/bin/bash
# $Id$
# This script is written by BÃ¸rre Gaup <boerre@skolelinux.no> and
# Tomi Pieski <tomi.pieski@hum.uit.no>
# It is licensed under the GPL, version 2 or later.
#
# Shell script for exporting divvun.no and giellaktekno www-pages from cvs 
# to the official www-directory
#
# To get cvs ssh working without password prompting:
# Stand in the home directory of your own machine, and write: 
# ssh-keygen -t rsa
# <just type enter to all questions>
# chmod 0644 $HOME/.ssh/id_rsa.pub
# then login to victorio, and write
# mkdir $HOME/.ssh
# chmod 700 $HOME/.ssh
# then logout from victorio, and write
# scp $HOME/.ssh/id_rsa.pub <user>@victorio.uit.no:.ssh/authorized_keys2
#

export LC_ALL=no_NO.UTF-8
FORREST_HOME=$HOME/forrest
PATH=$PATH:$FORREST_HOME/bin

update_trunk()
{
    cd
    if ! [ -x trunk ]; then
	svn co https://victorio.uit.no/repos/trunk
    else
	cd trunk
	svn up
	cd
    fi
}

# This function validates the documents in xtdoc/gt 
# directory and build the gtuit and ped sites

build_and_copy_sites()
{
	cd $HOME/trunk/xtdoc/gtuit
		sed -i 's/<search provider="lucene" name="Giellatekno" \/>/<search provider="google" domain="giellatekno.uit.no" name="Giellatekno" \/>/g' src/documentation/skinconf.xml

	# Build the site, at the same time checking the docs
	forrest clean
	forrest -Dforrest.jvmargs=-Djava.awt.headless=true validate-xdocs
	if [ "$?"  == "0" ]
	then
		nice -n 10 forrest -Dforrest.jvmargs=-Djava.awt.headless=true
		cd build/site
		scp -r  * gtuit@giellatekno.uit.no:public_html/.
		cd $HOME/trunk/ped
		nice -n 10 forrest -Dforrest.jvmargs=-Djava.awt.headless=true
		cd $HOME/trunk/ped/build/site/no
		scp -r  * gtuit@giellatekno.uit.no:public_html/oahpa/.
	else
	    echo "Build failed ..."
	    exit 1
	fi
}

update_trunk
build_and_copy_sites

echo "Done updating giellatekno:-)!"
