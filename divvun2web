#!/bin/bash
# $Id$
# This script is written by BÃ¸rre Gaup <boerre@skolelinux.no> and
# Tomi Pieski <tomi.pieski@hum.uit.no>
# It is licensed under the GPL, version 2 or later.
#
# Shell script for exporting divvun.no and giellaktekno www-pages from cvs 
# to the official www-directory
#
# To get cvs ssh working without password prompting:
# ssh-keygen -t rsa
# <just type enter to all questions>
# chmod 0644 $HOME/.ssh/id_rsa.pub
# login to victorio
# mkdir $HOME/.ssh
# chmod 700 $HOME/.ssh
# logout from victorio
# scp $HOME/.ssh/id_rsa.pub <user>@victorio.uit.no:.ssh/authorized_keys2
export LC_ALL=no_NO.UTF-8
FORREST_HOME=$HOME/forrest
PATH=$PATH:$FORREST_HOME/bin
CVS_RSH=ssh
MAIL_FROM="boerre@victorio.uit.no"
MAIL_TO="borre.gaup@samediggi.no"
# This function uses cvs to checkout the directory given as it's argument,
# or updates the given directory.

checkout()
{
    TEMPDIR=$1
    echo "Updating $TEMPDIR ..."
    cd
    if  ! [ -x $TEMPDIR ]; then
        cvs -d /usr/local/cvs/repository/ -Q co $TEMPDIR
    else
        cd $TEMPDIR
        cvs -d /usr/local/cvs/repository/ -Q -z4 up -dP
        cd
    fi
    if [ "$?" != "0" ]; then
        exit 1
    fi
    cd
}

# This function uses the 'checkout' function to update or checkout
# the two directories used in the giellatekno and divvun sites.
# It also makes a symbolic link to gt/doc in the gtuit and sd sites, 
# making complete 'forrest-trees' out of both xtdoc/sd and xtdoc/gtuit

fetch_giella_and_divvun()
{
    for CVS_DIR in xtdoc gt words st kt ped
    do
        checkout $CVS_DIR
    done

}

# This function validates the documents in xtdoc/gt 
# directory.

build_and_copy_sites()
{
	cd $HOME/xtdoc/gtuit
		sed -i 's/<search provider="lucene" name="Giellatekno" \/>/<search provider="google" domain="giellatekno.uit.no" name="Giellatekno" \/>/g' src/documentation/skinconf.xml

	# Build the site, at the same time checking the docs
	forrest clean
	rm -rf ../../words/dicts
	forrest -Dforrest.jvmargs=-Djava.awt.headless=true validate-xdocs
	if [ "$?"  == "0" ]
	then
		nice -n 10 forrest -Dforrest.jvmargs=-Djava.awt.headless=true
		cd build/site
		scp -r  * gtuit@giellatekno.uit.no:public_html/.
		cd $HOME/ped
		nice -n 10 forrest -Dforrest.jvmargs=-Djava.awt.headless=true
		cd $HOME/ped/build/site/no
		scp -r  * gtuit@giellatekno.uit.no:public_html/oahpa/.
	else
	    echo "Build failed ..."
	    exit 1
	fi
}

fetch_giella_and_divvun
build_and_copy_sites

echo "Done updating giellatekno:-)!"
