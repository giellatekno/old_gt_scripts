#!/bin/bash
# $Id$
# This script is written by BÃ¸rre Gaup <boerre@skolelinux.no> and
# Tomi Pieski <tomi.pieski@hum.uit.no>
# It is licensed under the GPL, version 2 or later.
#
# Shell script for exporting divvun.no and giellaktekno www-pages from cvs 
# to the official www-directory
#
# To get cvs ssh working without password prompting:
# ssh-keygen -t rsa
# <just type enter to all questions>
# chmod 0644 .ssh/id_rsa.pub
# login to victorio
# mkdir .ssh
# chmod 700 .ssh
# logout from victorio
# scp id_rsa.pub <user>@victorio.uit.no:.ssh/authorized_keys2
export LC_ALL=no_NO.UTF-8
FORREST_HOME=$HOME/forrest
PATH=$PATH:$FORREST_HOME/bin
CVS_RSH=ssh
MAIL_FROM="boerre@victorio.uit.no"
MAIL_TO="borre.gaup@samediggi.no"
# This function uses cvs to checkout the directory given as it's argument,
# or updates the given directory.

checkout()
{
    TEMPDIR=$1
    echo "Updating $TEMPDIR ..."
    cd
    if  ! [ -x $TEMPDIR ]; then
        cvs -d /usr/local/cvs/repository/ -Q co $TEMPDIR
    else
        cd $TEMPDIR
        cvs -d /usr/local/cvs/repository/ -Q -z4 up -dP
        cd
    fi
    if [ "$?" != "0" ]; then
            echo "cvs up failed in $TEMPDIR ..."
        (echo "From: $MAIL_FROM"
        echo "Subject: cvs update error"
        echo "TO:$MAIL_TO"
        echo "")|/usr/lib/sendmail -t
        exit 1
    fi
    cd
}

# This function uses the 'checkout' function to update or checkout
# the two directories used in the giellatekno and divvun sites.
# It also makes a symbolic link to gt/doc in the gtuit and sd sites, 
# making complete 'forrest-trees' out of both xtdoc/sd and xtdoc/gtuit

fetch_giella_and_divvun()
{
    for CVS_DIR in xtdoc gt words st kt
    do
        checkout $CVS_DIR
    done

}

# This function validates the documents in the xtdoc/sd and xtdoc/gt 
# directories.
# If successfull it copies the relevant files to the tomcat-servers 
# directories, else it sends an e-mail to the site administrator.

build_and_copy_sites()
{
    cd
    rm gt/doc/lang/corp/corpus-summary-2006-05-16.xml
    #rm gt/doc/lang/corp/corpus-summary.xml
    #rm gt/doc/lang/corp/corpus-content.xml

    for SITE in gtuit
    do
        cd $HOME/xtdoc/$SITE
#         if [ "$SITE" == "sd" ]; then
#             sed -i 's/<search provider="lucene" name="Divvun" \/>/<search provider="google" domain="www.divvun.no" name="Divvun" \/>/g' src/documentation/skinconf.xml
#         else
            sed -i 's/<search provider="lucene" name="Giellatekno" \/>/<search provider="google" domain="giellatekno.uit.no" name="Giellatekno" \/>/g' src/documentation/skinconf.xml
#         fi

        # Build the site, at the same time checking the docs
        echo "Cleaning old build ..."
        #forrest clean
        echo "Validating $SITE ..."
        forrest -Dforrest.jvmargs=-Djava.awt.headless=true validate-xdocs

        # $? is the status of the last executed program.
        # 0 is success, anything else indicates some kind of error
        if [ "$?"  == "0" ]
        then
            echo "Building site ..."
            nice -n 10 forrest -Dforrest.jvmargs=-Djava.awt.headless=true
            echo "Copying file to $SITE..."
            cd build/site
            scp -rq * $SITE@giellatekno.uit.no:public_html/.
            if [ "$?"  != "0" ]
            then
                (
                echo "From: $MAIL_FROM"
                echo "Subject: Error copying files to webapps dir"
                echo "TO:$MAIL_TO"
                echo ""
                )|/usr/lib/sendmail -t
                echo "copying files to $SITE failed..."
            fi
        else
            echo "Sending error mail ..."
            (
            echo "From: $MAIL_FROM"
            echo "Subject: Error validating files in $SITE"
            echo "TO:$MAIL_TO"
            echo ""
            #cat $ERROR_FILE
            )|/usr/lib/sendmail -t
        fi
    done
}

fetch_giella_and_divvun
build_and_copy_sites

echo "Done updating giellatekno:-)!"
