#!/usr/bin/perl -w

use strict;
use encoding 'utf-8';
use open ':utf8';
use XML::Twig;
use File::Find;
use Getopt::Long;


my $all;
my $para = 'true';
my $title;
my $list;
my $table;
my $help;
my @input;

GetOptions ('para!' => \$para,
	    'all' => \$all,
	    'title' => \$title,
	    'list' => \$list,
	    'table' => \$table,
	    'help' => \$help,
	    'input=s' => \@input);

if ($all) {
    $title = 'true';
    $list = 'true';
    $table = 'true';
}

if ($help) {
    &print_usage;
    exit;
}


foreach my $in (@input) {
    find ( \&process_file, $in) if -d $in;
    process_file ($in) if -f $in;
}


sub process_file {
    my $file = $_;
    $file = shift (@_) if (!$file);
    return if $file =~ /^\./;
    return unless $file =~ /\.xml$/;

    my $document = XML::Twig->new(twig_handlers =>
				  {p => \&process_xml} );

    $document->parsefile ($file);
}

sub process_xml {
    my ($twig, $elt) = @_;

    if ($para) {
		if (!$elt->att("type") || $elt->att("type") =~ "text") {
		    print $elt->text;
		}
    }

    if ($title) {
		if ($elt->att("type") && $elt->{'att'}->{'type'} =~ "title") {
		    print $elt->text;
		    print "¶\n";             # Specical sign for titles
		}
    }

    if ($list) {
        if ($elt->att("type") && $elt->att("type") =~ "listitem") {
		    print $elt->text;
		    print "¶";               # Using the title sign also here
        }
    }

    if ($table) {
		if ($elt->att("type") && $elt->att("type") =~ "tablecell") {
		    print $elt->text;
		    print "¶";               # Using the title sign also here
		}
    }

    $twig->purge;
}

sub print_usage {
    print "\nUsage: catxml <options> [-i | --input] [FileName | Directory]\n";
    print "\nwhere possible options include:\n";
    print "[-a | --all]\t\t\tPrint all text elements\n";
    print "[-p | --para]\t\t\tPrint paragraphs with text content (default)\n";
    print "[-nop | --nopara]\t\tDon't print text paragraphs\n";
    print "[-ti | --title]\t\t\tPrint paragraphs with title type\n";
    print "[-l | --list]\t\t\tPrint paragraphs with list type\n";
    print "[-ta | --table]\t\t\tPrint paragraphs with table type\n";
    print "\n";
}
